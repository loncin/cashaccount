# å…±äº«è®°è´¦ (CashAccount) Bug ä¿®å¤æŠ¥å‘Š

## ä¿®å¤æ—¶é—´
2026-02-08

## ä¿®å¤æ¦‚è¿°
æœ¬æ¬¡ä¿®å¤å…±å‘çŽ°å¹¶ä¿®å¤äº† 15+ ä¸ª bugï¼Œæ¶µç›–ä¸¥é‡ã€é«˜ã€ä¸­ã€ä½Žå››ä¸ªçº§åˆ«ã€‚

---

## ðŸ”´ ä¸¥é‡çº§åˆ« Bug (Critical)

### 1. app.js - initData é”™è¯¯å¤„ç†ç¼ºå¤±
**é—®é¢˜æè¿°ï¼š**
- `initData` å‡½æ•°åœ¨äº‘å‡½æ•°è°ƒç”¨å¤±è´¥æ—¶æ²¡æœ‰æ­£ç¡®æŠ›å‡ºé”™è¯¯ï¼Œå¯¼è‡´åº”ç”¨çŠ¶æ€ä¸ä¸€è‡´
- ç¼ºå°‘å¯¹è¿”å›žç»“æžœçš„æ ¡éªŒ

**ä¿®å¤å†…å®¹ï¼š**
- æ·»åŠ äº†å¯¹è¿”å›žç»“æžœçš„æ ¡éªŒ (`res.result && res.result.groupId`)
- åœ¨å¤±è´¥æ—¶å‘ä¸ŠæŠ›å‡ºé”™è¯¯ï¼Œä»¥ä¾¿è°ƒç”¨æ–¹å¤„ç†
- æ·»åŠ äº†ç”¨æˆ·æç¤º

```javascript
// ä¿®å¤å‰
groupId = res.result.groupId;  // å¯èƒ½æŠ¥é”™

// ä¿®å¤åŽ
if (res.result && res.result.groupId) {
  groupId = res.result.groupId;
  // ...
} else {
  throw new Error('åˆ›å»ºç¾¤ç»„è¿”å›žæ•°æ®å¼‚å¸¸');
}
```

### 2. pages/add/add.js - é¢„ç®—è¶…æ”¯å¼¹çª—é€»è¾‘é”™è¯¯
**é—®é¢˜æè¿°ï¼š**
- é¢„ç®—è¶…æ”¯æ—¶å¼¹çª—çš„ Promise å¤„ç†é€»è¾‘é”™è¯¯
- ç”¨æˆ·ç‚¹å‡»"å–æ¶ˆ"æ—¶æŠ›å‡º `user_cancelled` é”™è¯¯ï¼Œä½†ä¼šè¢« catch æ•èŽ·å¯¼è‡´æ˜¾ç¤º"ä¿å­˜å¤±è´¥"
- å®žé™…ä¸Šç”¨æˆ·åªæ˜¯æƒ³å–æ¶ˆï¼Œä¸åº”è¯¥æ˜¾ç¤ºé”™è¯¯

**ä¿®å¤å†…å®¹ï¼š**
- æ”¹ç”¨ `resolve(res.confirm)` è¿”å›žç”¨æˆ·é€‰æ‹©
- å¦‚æžœç”¨æˆ·å–æ¶ˆï¼Œç›´æŽ¥ `return` ä¸ç»§ç»­ä¿å­˜
- ç§»é™¤äº† `user_cancelled` é”™è¯¯æŠ›å‡ºæœºåˆ¶

```javascript
// ä¿®å¤å‰
await new Promise((resolve) => {
  wx.showModal({
    // ...
    success: (res) => {
      if (res.confirm) resolve();
      else throw new Error('user_cancelled');  // é”™è¯¯çš„åšæ³•
    }
  });
});

// ä¿®å¤åŽ
const userConfirmed = await new Promise((resolve) => {
  wx.showModal({
    // ...
    success: (res) => resolve(res.confirm),
    fail: () => resolve(false)
  });
});

if (!userConfirmed) {
  wx.hideLoading();
  return; // ç”¨æˆ·å–æ¶ˆï¼Œä¸ä¿å­˜
}
```

### 3. cloudfunctions/ocrAction/index.js - é”™è¯¯å¤„ç†ä¸å½“
**é—®é¢˜æè¿°ï¼š**
- OCR è¯†åˆ«å¤±è´¥æ—¶ç›´æŽ¥è¿”å›ž `err` å¯¹è±¡ï¼Œæ²¡æœ‰ç»Ÿä¸€çš„é”™è¯¯æ ¼å¼
- å‰ç«¯æ— æ³•æ­£ç¡®è¯†åˆ«é”™è¯¯çŠ¶æ€
- ç¼ºå°‘å‚æ•°æ ¡éªŒ

**ä¿®å¤å†…å®¹ï¼š**
- æ·»åŠ äº† `fileId` å‚æ•°æ ¡éªŒ
- ç»Ÿä¸€è¿”å›žæ ¼å¼ `{ code, message, items }`
- åœ¨é”™è¯¯æƒ…å†µä¸‹ä¹Ÿè¿”å›žç»Ÿä¸€çš„æ ¼å¼

---

## ðŸŸ  é«˜çº§åˆ« Bug (High)

### 4. pages/index/index.js - ç»Ÿè®¡æ•°æ®è§£æžé—®é¢˜
**é—®é¢˜æè¿°ï¼š**
- `statsRes.result.month` å¯èƒ½ä¸å­˜åœ¨ï¼Œä½†ä»£ç ç›´æŽ¥è®¿é—®å…¶å±žæ€§
- ç¼ºå°‘é»˜è®¤å€¼å¤„ç†
- `item.total` å¯èƒ½ä¸º undefined å¯¼è‡´ NaN

**ä¿®å¤å†…å®¹ï¼š**
- æ·»åŠ äº†é»˜è®¤å€¼ `0`
- é‡æž„äº†ç»Ÿè®¡è§£æžé€»è¾‘ï¼Œä½¿å…¶æ›´åŠ å¥å£®
- åˆ†å¼€å¤„ç† `month` å’Œ `total` æ•°æ®

### 5. cloudfunctions/cloudApi/index.js - é‡‘é¢èšåˆè½¬æ¢é—®é¢˜
**é—®é¢˜æè¿°ï¼š**
- `$toDouble` è½¬æ¢åœ¨ `amount` å·²ç»æ˜¯æ•°å­—æ—¶ä¼šå¤±è´¥
- äº‘æ•°æ®åº“ä¸­é‡‘é¢å¯èƒ½å­˜å‚¨ä¸ºå­—ç¬¦ä¸²æˆ–æ•°å­—ï¼Œæ··åˆç±»åž‹å¯¼è‡´èšåˆå‡ºé”™

**ä¿®å¤å†…å®¹ï¼š**
- ä½¿ç”¨ `$.cond` å’Œ `$.isNumber` è¿›è¡Œæ¡ä»¶åˆ¤æ–­
- å¦‚æžœæ˜¯æ•°å­—ç›´æŽ¥ä½¿ç”¨ï¼Œå¦åˆ™è½¬æ¢ä¸ºåŒç²¾åº¦æµ®ç‚¹æ•°

```javascript
// ä¿®å¤å‰
total: $.sum({ $toDouble: '$amount' })  // å¦‚æžœ amount æ˜¯æ•°å­—ä¼šå¤±è´¥

// ä¿®å¤åŽ
total: $.sum($.cond({
  if: $.isNumber('$amount'),
  then: '$amount',
  else: $.toDouble('$amount')
}))
```

### 6. pages/stats/stats.js - æˆå‘˜ç»Ÿè®¡ç¼ºå¤±
**é—®é¢˜æè¿°ï¼š**
- `memberStats` å§‹ç»ˆè®¾ç½®ä¸ºç©ºæ•°ç»„
- äº‘å‡½æ•° `getDetailedStats` æ²¡æœ‰è¿”å›žæˆå‘˜ç»Ÿè®¡æ•°æ®

**ä¿®å¤å†…å®¹ï¼š**
- åœ¨äº‘å‡½æ•°ä¸­æ·»åŠ äº† `memberRes` èšåˆæŸ¥è¯¢
- å‰ç«¯æ·»åŠ äº†å¯¹ `memberStats` çš„å¤„ç†é€»è¾‘
- è¿”å›žæ ¼å¼ä¸Žå…¶ä»–ç»Ÿè®¡ä¿æŒä¸€è‡´

### 7. pages/accounts/accounts.js - ä½™é¢è®¡ç®—ç²¾åº¦é—®é¢˜
**é—®é¢˜æè¿°ï¼š**
- ä½¿ç”¨ `Number()` è½¬æ¢é‡‘é¢åœ¨æŸäº›æƒ…å†µä¸‹ä¼šä¸¢å¤±ç²¾åº¦
- è´¢åŠ¡è®¡ç®—éœ€è¦é«˜ç²¾åº¦å¤„ç†

**ä¿®å¤å†…å®¹ï¼š**
- ä½¿ç”¨ `parseFloat()` æ›¿ä»£ `Number()`
- æ·»åŠ äº† `|| 0` é»˜è®¤å€¼å¤„ç†

### 8. cloudfunctions/cloudApi/index.js - æƒé™æ£€æŸ¥ç«žæ€æ¡ä»¶
**é—®é¢˜æè¿°ï¼š**
- `checkGroupPermission` ä¸­ç¾¤ç»„ä¸å­˜åœ¨æ—¶å¹¶å‘åˆ›å»ºå¯èƒ½å¯¼è‡´é‡å¤åˆ›å»ºé”™è¯¯
- é”™è¯¯å¤„ç†ä¸å¤Ÿå®Œå–„

**ä¿®å¤å†…å®¹ï¼š**
- æ·»åŠ äº† `groupId` ç±»åž‹æ ¡éªŒ
- æ”¹è¿›äº†é”™è¯¯å¤„ç†é€»è¾‘ï¼Œæ·»åŠ  try-catch
- å¤„ç†å¹¶å‘æƒ…å†µä¸‹çš„é‡è¯•é€»è¾‘

---

## ðŸŸ¡ ä¸­çº§åˆ« Bug (Medium)

### 9. pages/calendar/calendar.js - åˆ é™¤äº¤æ˜“ç¼ºå°‘é”™è¯¯å¤„ç†
**é—®é¢˜æè¿°ï¼š**
- `deleteTransaction` æ²¡æœ‰ try-catch
- æ²¡æœ‰ loading çŠ¶æ€å’Œç”¨æˆ·åé¦ˆ
- åˆ é™¤å¤±è´¥æ—¶ç”¨æˆ·ä¸çŸ¥é“

**ä¿®å¤å†…å®¹ï¼š**
- æ·»åŠ äº†å®Œæ•´çš„ try-catch-finally
- æ·»åŠ äº† loading æç¤º
- æ·»åŠ äº†æˆåŠŸ/å¤±è´¥çš„ç”¨æˆ·åé¦ˆ

### 10. pages/debts/debts.js - åµŒå¥— ActionSheet å¤„ç†ä¸å½“
**é—®é¢˜æè¿°ï¼š**
- åµŒå¥—çš„ `wx.showActionSheet` æ²¡æœ‰å¤„ç† `fail` å›žè°ƒ
- ç”¨æˆ·å–æ¶ˆé€‰æ‹©æ—¶æ²¡æœ‰å¤„ç†

**ä¿®å¤å†…å®¹ï¼š**
- æ·»åŠ äº† `fail` å›žè°ƒå¤„ç†
- æ·»åŠ äº†ç©ºè´¦æˆ·æ£€æŸ¥

### 11. cloudfunctions/cloudApi/index.js - å‘¨æœŸæ€§è®°è´¦æ—¥æœŸè®¡ç®—é—®é¢˜
**é—®é¢˜æè¿°ï¼š**
- æ—¶åŒºè®¡ç®—ä½¿ç”¨ç¡¬ç¼–ç çš„ `+8` å°æ—¶ï¼Œä¸å¤Ÿå¥å£®
- `nextDateStr` æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨å¾ªçŽ¯ä¸­è°ƒç”¨å¯èƒ½å¯¼è‡´é—®é¢˜
- æ—¥æœŸå­—ç¬¦ä¸²æ¯”è¾ƒå¯èƒ½ä¸å‡†ç¡®

**ä¿®å¤å†…å®¹ï¼š**
- ä½¿ç”¨ç»Ÿä¸€çš„æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°
- ä½¿ç”¨ `getNextDate` è¾…åŠ©å‡½æ•°è®¡ç®—ä¸‹ä¸€ä¸ªæ—¥æœŸ
- ç§»é™¤äº†å‡½æ•°å½¢å¼çš„æ—¥æœŸå­—ç¬¦ä¸²èŽ·å–

```javascript
// ä¿®å¤å‰
const nextDateStr = () => `${nextDate.getFullYear()}-${...}`;
while (nextDateStr() <= todayStr) { ... }

// ä¿®å¤åŽ
const formatDateStr = (date) => { ... };
while (formatDateStr(nextDate) <= todayStr) {
  const dateStr = formatDateStr(nextDate);
  // ...
}
```

### 12. pages/add/add.js - å‘¨æœŸæ€§è®°è´¦è§„åˆ™ç¼ºå°‘ groupId
**é—®é¢˜æè¿°ï¼š**
- åˆ›å»ºå‘¨æœŸæ€§è®°è´¦è§„åˆ™æ—¶æ²¡æœ‰åŒ…å« `groupId` å­—æ®µ
- å¯èƒ½å¯¼è‡´è§„åˆ™æ— æ³•æ­£ç¡®å…³è”åˆ°ç¾¤ç»„

**ä¿®å¤å†…å®¹ï¼š**
- åœ¨ `rule` å¯¹è±¡ä¸­æ·»åŠ äº† `groupId` å­—æ®µ

---

## ðŸŸ¢ ä½Žçº§åˆ« Bug (Low)

### 13. pages/groups/groups.js - å¹¶å‘è¯·æ±‚æ— é™åˆ¶
**é—®é¢˜æè¿°ï¼š**
- `loadGroups` åŒæ—¶å‘èµ·æ‰€æœ‰è¯·æ±‚ï¼Œå¦‚æžœè´¦æœ¬æ•°é‡è¿‡å¤šå¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜

**ä¿®å¤å†…å®¹ï¼š**
- æ·»åŠ äº†å¹¶å‘æŽ§åˆ¶ï¼ˆæ¯æ‰¹ 5 ä¸ªè¯·æ±‚ï¼‰

### 14. app.js - handleShareOptions é¡µé¢åˆ·æ–°é—®é¢˜
**é—®é¢˜æè¿°ï¼š**
- é‡æ–°åŠ è½½é¡µé¢æ—¶ç›´æŽ¥è°ƒç”¨ `currentPage.onShow()`ï¼Œæ²¡æœ‰æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨

**ä¿®å¤å†…å®¹ï¼š**
- æ·»åŠ äº† `typeof currentPage.onShow === 'function'` æ£€æŸ¥

### 15. pages/add/add.js - æäº¤æ—¶æ•°æ®æ ¡éªŒä¸è¶³
**é—®é¢˜æè¿°ï¼š**
- æäº¤æ—¶æ²¡æœ‰æ£€æŸ¥ `groupId` æ˜¯å¦å­˜åœ¨
- æ²¡æœ‰æ£€æŸ¥å¿…è¦æ•°æ®æ˜¯å¦å·²åŠ è½½

**ä¿®å¤å†…å®¹ï¼š**
- æ·»åŠ äº† `groupId` å­˜åœ¨æ€§æ£€æŸ¥
- æ·»åŠ äº† `accounts`ã€`members`ã€`categories` å­˜åœ¨æ€§æ£€æŸ¥

---

## ä¿®å¤æ–‡ä»¶åˆ—è¡¨

| æ–‡ä»¶è·¯å¾„ | ä¿®å¤çº§åˆ« | ä¿®å¤æ•°é‡ |
|---------|---------|---------|
| `/app.js` | Critical | 2 |
| `/pages/add/add.js` | Critical/High/Medium | 4 |
| `/pages/index/index.js` | High | 1 |
| `/pages/stats/stats.js` | High | 1 |
| `/pages/accounts/accounts.js` | High | 1 |
| `/pages/calendar/calendar.js` | Medium | 1 |
| `/pages/debts/debts.js` | Medium | 1 |
| `/pages/groups/groups.js` | Low | 1 |
| `/cloudfunctions/cloudApi/index.js` | High/Medium | 4 |
| `/cloudfunctions/ocrAction/index.js` | Critical | 1 |

---

## å»ºè®®çš„åŽç»­ä¼˜åŒ–

1. **æ·»åŠ æ›´å¤šå•å…ƒæµ‹è¯•**ï¼Œç‰¹åˆ«æ˜¯äº‘å‡½æ•°çš„æµ‹è¯•
2. **æ·»åŠ è¾“å…¥æ•°æ®æ ¡éªŒ**ï¼Œä½¿ç”¨ JSON Schema éªŒè¯å‰ç«¯å’ŒåŽç«¯çš„æ•°æ®
3. **ä¼˜åŒ–å¤§æ•°æ®é‡æŸ¥è¯¢**ï¼Œä¸º `transactions` é›†åˆæ·»åŠ æ›´å¤šç´¢å¼•
4. **å®Œå–„é”™è¯¯ä¸ŠæŠ¥**ï¼ŒæŽ¥å…¥å°ç¨‹åºé”™è¯¯ç›‘æŽ§ç³»ç»Ÿ
5. **æ·»åŠ æ“ä½œæ—¥å¿—**ï¼Œè®°å½•é‡è¦çš„æ•°æ®å˜æ›´æ“ä½œ

---

## ä¿®å¤éªŒè¯æ¸…å•

- [x] åº”ç”¨å¯ä»¥æ­£å¸¸å¯åŠ¨
- [x] æ–°ç”¨æˆ·å¯ä»¥æ­£å¸¸åˆ›å»ºè´¦æœ¬
- [x] è®°è´¦åŠŸèƒ½æ­£å¸¸
- [x] é¢„ç®—è®¾ç½®å’Œè¶…æ”¯æé†’æ­£å¸¸
- [x] ç»Ÿè®¡å›¾è¡¨æ­£å¸¸æ˜¾ç¤º
- [x] æˆå‘˜ç»Ÿè®¡æ­£å¸¸æ˜¾ç¤º
- [x] è´¦æˆ·ä½™é¢è®¡ç®—æ­£ç¡®
- [x] å‘¨æœŸæ€§è®°è´¦æ­£å¸¸ç”Ÿæˆ
- [x] OCR è¯†åˆ«é”™è¯¯å¤„ç†æ­£å¸¸
- [x] åˆ†äº«å’ŒåŠ å…¥ç¾¤ç»„æ­£å¸¸
