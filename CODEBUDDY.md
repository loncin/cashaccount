# CODEBUDDY.md

本项目是一个基于微信小程序云开发的协作记账应用。本文档旨在为 CodeBuddy Code 提供开发规范、架构说明及常见任务指导。

## 开发常用命令

由于本项目是微信小程序，大部分开发工作在 **微信开发者工具** 中完成。

- **环境配置**：在 `app.js` 的 `wx.cloud.init` 中设置正确的云环境 ID（`env`）。
- **运行与预览**：直接在微信开发者工具中导入项目，工具会自动编译并在模拟器中运行。
- **云函数部署**：
  - 在 `cloudfunctions` 目录下右键点击具体的云函数文件夹（如 `cloudApi`）。
  - 选择“上传并部署：所有文件”（或“云端安装依赖”）。
- **数据库管理**：通过微信开发者工具顶部的“云开发”按钮进入控制台，管理集合、索引及权限。
- **Lint 与测试**：目前未配置 CLI 脚本，主要通过模拟器进行手动回归测试。

## 核心架构设计

### 技术栈
- **前端**：微信小程序原生开发（WXML, WXSS, JavaScript）。
- **后端**：微信云开发（CloudBase）云函数。
- **数据库**：云开发 NoSQL 数据库。

### 关键架构模式
1. **Action 路由模式**：核心逻辑集中在 `cloudApi` 云函数中，通过 `action` 参数分发具体业务（如 `addTransaction`, `getStats` 等）。
2. **基于 Group 的多租户隔离**：所有账务数据均绑定 `groupId`。用户通过加入群组进行协作。云函数内强制执行 `checkGroupPermission` 校验。
3. **数据初始化机制**：分类（categories）、成员（members）和账户（accounts）在首次访问时若不存在，会自动初始化默认值。
4. **OCR 识别流**：通过 `ocrAction` 调用微信官方 OCR 接口，提取凭证图片中的金额和日期。

## 开发规范与最佳实践（基于最近修复）

在修改或新增功能时，请务必遵循以下模式：

### 1. 错误处理与用户反馈
- **异步操作**：必须使用 `try-catch-finally` 结构。
- **加载状态**：在调用云函数前后使用 `wx.showLoading` 和 `wx.hideLoading`。
- **异常提示**：捕获错误后，使用 `wx.showToast({ title: '...', icon: 'none' })` 告知用户。

### 2. 数据校验
- **前置检查**：在提交表单或执行删除操作前，必须校验 `groupId` 及必要的配置数据（如账户、分类是否已加载）。
- **金额计算**：处理数据库返回的金额时，统一使用 `parseFloat()` 或在聚合中使用 `$toDouble`，以避免字符串拼接或精度丢失。

### 3. 云函数开发
- **权限校验**：所有涉及敏感数据的 `action` 必须首先调用 `checkGroupPermission(groupId)`。
- **数据库聚合**：在 `getStats` 等聚合操作中，应处理 `amount` 可能为字符串或数字的兼容性（参考 `$.cond` 逻辑）。
- **日期处理**：云函数环境为 UTC 时间，处理本地日期时需注意 8 小时时差，推荐使用格式化函数统一处理 `YYYY-MM-DD` 格式。

### 4. 性能优化
- **并发控制**：在循环调用云函数时（如加载多个群组信息），应使用分批处理（如每 5 个一组）以避免触发环境限制。

## 关键文件索引
- `app.js`：应用入口，处理初始化、群组切换及周期性账单生成。
- `cloudfunctions/cloudApi/index.js`：后端核心逻辑。
- `pages/index/`：首页，展示余额、本月收支及预算进度。
- `pages/add/`：记账页，集成 OCR 及预算超支提醒。
- `project.config.json`：小程序编译及项目配置。
